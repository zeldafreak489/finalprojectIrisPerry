{% extends "base.html" %}
{% block content %}

<div class="container">

    <!-- PROFILE HEADER -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex align-items-center">
            <img src="{{ profile_user.profile.profile_picture.url }}"
                 class="rounded-circle me-3"
                 width="80" height="80"
                 style="object-fit: cover;">

            <div>
                <h2 class="mb-0">{{ profile_user.username }}</h2>
                <small class="text-muted">Member since {{ profile_user.date_joined|date:"M Y" }}</small>
                <div class="mt-2">
                    <span class="me-3"><strong>{{ follower_count }}</strong> Followers</span>
                    <span><strong>{{ following_count }}</strong> Following</span>
                </div>
            </div>
        </div>
    </div>

    <!-- QUICK STATS -->
    <div class="row mb-4 text-center">
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>{{ rating_count }}</h5>
                <small class="text-muted">Ratings</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>{{ review_count }}</h5>
                <small class="text-muted">Reviews</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>{{ playing_count }}</h5>
                <small class="text-muted">Currently Playing</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <h5>{{ completed_count }}</h5>
                <small class="text-muted">Completed</small>
            </div>
        </div>
    </div>

    <!-- ACTIVITY FEED -->
    <h4 class="mt-4">Recent Activity</h4>

    {% if activities %}
    <ul class="list-group mt-2">
        {% for activity in activities %}
            <li class="list-group-item">
                {{ profile_user.username }}
                {% if activity.activity_type == "add" %}
                    added
                {% elif activity.activity_type == "status" %}
                    updated
                {% endif %}
                <strong>{{ activity.game_title }}</strong>
                <small class="text-muted">({{ activity.created_at|timesince }} ago)</small>
            </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="text-muted">No recent activity.</p>
    {% endif %}


    <!-- FRIENDS / FOLLOWING -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Friends</strong>
            <small class="text-muted">({{ friends|length }})</small>
        </div>
        <div class="card-body d-flex flex-wrap gap-3">
            {% for friend in friends %}
                <div class="text-center">
                    <a href="{% url 'accounts:user_profile' friend.username %}">
                        <img src="{{ friend.profile.profile_picture.url }}"
                             class="rounded-circle mb-1"
                             width="50" height="50">
                        <div style="font-size: 0.85rem;">{{ friend.username }}</div>
                    </a>
                </div>
            {% empty %}
                <p class="text-muted mb-0">No friends yet.</p>
            {% endfor %}
        </div>
    </div>

    <!-- GAME SHELF LINKS -->
    {% if user == profile_user %}
    <div class="text-center mb-5">
        <h5>Your Shelves</h5>
        <a href="{% url 'library:my_library' %}?shelf=want" class="btn btn-outline-primary btn-sm me-2">Want to Play</a>
        <a href="{% url 'library:my_library' %}?shelf=playing" class="btn btn-outline-primary btn-sm me-2">Currently Playing</a>
        <a href="{% url 'library:my_library' %}?shelf=played" class="btn btn-outline-primary btn-sm">Completed</a>
    </div>
    {% endif %}

</div>


<!-- Your JS remains the same -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("followForm");
    if (!form) return;

    const btn = document.getElementById("followBtn");
    const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        fetch(form.action, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "X-Requested-With": "XMLHttpRequest"
            },
        })
        .then(res => res.json())
        .then(data => {
            if (data.status) {
                btn.textContent = data.status === "followed" ? "Unfollow" : "Follow";
                document.getElementById("followerCount").textContent = data.follower_count;
            }
        });
    });
});
</script>

{% endblock %}
