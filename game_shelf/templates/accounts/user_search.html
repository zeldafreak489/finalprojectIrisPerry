{% extends "base.html" %}
{% block content %}

<h2>Find Users</h2>

<form method="get" class="mb-3">
    <input 
        type="text"
        name="q"
        value="{{ query }}"
        class="form-control"
        placeholder="Search by username...">
</form>

{% if results %}
<ul class="list-group mt-3">
    {% for user in results %}
        <li class="list-group-item d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <img src="{{ user.profile.profile_picture.url }}"
                     width="40" height="40"
                     class="rounded-circle object-fit-cover">

                <a href="{% url 'accounts:user_profile' user.username %}">
                    {{ user.username }}
                </a>
            </div>

            <button
                class="btn btn-sm follow-btn {% if user.id in following_ids %}btn-secondary{% else %}btn-primary{% endif %}"
                data-username="{{ user.username }}"
            >
                {% if user.id in following_ids %}
                    Unfollow
                {% else %}
                    Follow
                {% endif %}
            </button>
        </li>
    {% endfor %}
</ul>
{% elif query %}
<p>No users found.</p>
{% endif %}

<script>
const buttons = document.querySelectorAll(".follow-btn");

buttons.forEach(btn => {
    btn.addEventListener("click", () => {
        const username = btn.dataset.username;

        fetch(`/accounts/follow/${username}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "X-Requested-With": "XMLHttpRequest",
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.is_following) {
                btn.textContent = "Unfollow";
                btn.classList.remove("btn-primary");
                btn.classList.add("btn-secondary");
            } else {
                btn.textContent = "Follow";
                btn.classList.remove("btn-secondary");
                btn.classList.add("btn-primary");
            }
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
