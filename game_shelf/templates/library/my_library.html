{% extends "base.html" %}
{% block content %}
<h2>My Library</h2>
<hr>

<!-- Shelf Filter Buttons -->
<div class="d-flex gap-2 mb-4">
    <a href="{% url 'library:my_library' %}"
       class="btn btn-secondary {% if not active_shelf %}active{% endif %}">
       All
    </a>

    <a href="?shelf=want"
       class="btn btn-outline-primary {% if active_shelf == 'want' %}active{% endif %}">
       Want to Play
    </a>

    <a href="?shelf=playing"
       class="btn btn-outline-primary {% if active_shelf == 'playing' %}active{% endif %}">
       Currently Playing
    </a>

    <a href="?shelf=played"
       class="btn btn-outline-primary {% if active_shelf == 'played' %}active{% endif %}">
       Played
    </a>
</div>

{% if games %}
<div class="row">
    {% for game in games %}
    <div class="col-md-3 mb-4" id="game-card-{{game.rawg_id}}">
        <div class="card h-100" data-id="{{ game.rawg_id }}">
            <a href="{% url 'library:detail' game.rawg_id %}">
                {% if game.cover_image %}
                <img src="{{ game.cover_image }}" class="card-img-top" alt="{{ game.title }}">
                {% endif %}
            </a>
            <div class="card-body">
                <h5 class="card-title">
                    <a href="{% url 'library:detail' game.rawg_id %}" class="text-decoration-none text-dark">
                        {{ game.title }}
                    </a>
                </h5>

                <!-- Shelf Dropdown -->
                <form class="shelfForm" data-rawg-id="{{ game.rawg_id }}">
                    {% csrf_token %}
                    <select name="status">
                        <option value="want" {% if game.shelf == 'want' %}selected{% endif %}>Want to Play</option>
                        <option value="playing" {% if game.shelf == 'playing' %}selected{% endif %}>Currently Playing</option>
                        <option value="played" {% if game.shelf == 'played' %}selected{% endif %}>Played</option>
                    </select>
                </form>

                <!-- Remove Game from Library -->
                <form class="remove-game-form mt-2"
                    data-url="{% url 'library:remove_from_library' game.rawg_id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger w-100">
                        Remove
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p>You have no saved games yet.</p>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    document.querySelectorAll(".shelfForm select").forEach(select => {
        select.addEventListener("change", (e) => {
            const form = e.target.closest("form");
            const rawg_id = form.dataset.rawgId;
            const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            const shelf = e.target.value;

            fetch(`/library/game/${rawg_id}/update_shelf/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "X-Requested-With": "XMLHttpRequest",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `status=${shelf}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log("Shelf updated!");
                } else {
                    alert(data.error);
                }
            });
        });
    });
});
</script>

<!-- JS for removing game from library without reloading -->
<script>
document.querySelectorAll(".remove-game-form").forEach(form => {
    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const url = form.dataset.url;
        const csrftoken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(url, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const card = document.getElementById("game-card-" + data.rawg_id);
                if (card) {
                    card.remove();
                }
            }
        });
    });
});
</script>

{% endblock %}
